<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL 数据库学习笔记 - 我的个人博客</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/markdown.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>我的个人博客</h1>
            <nav>
                <span><a href="../index.html" class="no-underline">首页</a></span>
            </nav>
        </header>

        <main>
            <div class="messages-list">
                <div class="messages-header">
                    <h3>MySQL 数据库学习笔记</h3>
                    <a href="../index.html" class="btn">返回首页</a>
                </div>

                <div class="message-item">
                    <div class="message-header">
                        <span class="username">技术分享</span>
                        <span class="time">2025-12-20</span>
                    </div>
                    <div class="message-content">
                        <div class="markdown-content">
                            <h3>连接MySQL服务器</h3>
                            <h4>本地连接</h4>
                            <pre><code class="language-bash">mysql -u root -p</code></pre>
                            <h4>远程连接</h4>
                            <pre><code class="language-bash">mysql -h 主机IP -u 用户名 -p</code></pre>
                            <h4>SSH连接到远程MySQL</h4>
                            <pre><code class="language-bash">ssh 用户名@服务器IP
# 连接成功后再执行
mysql -u root -p</code></pre>
                            <h3>SSH配置（如需远程连接）</h3>
                            <p>编辑SSH配置文件 <code>/etc/ssh/sshd_config</code>：</p>
                            <pre><code class="language-bash"># 启用SSH端口
Port 22

# 允许root登录
PermitRootLogin yes

# 启用公钥认证
PubkeyAuthentication yes</code></pre>
                            <p>重启SSH服务：</p>
                            <pre><code class="language-bash">systemctl restart sshd</code></pre>
                            <hr>
                            <h2>创建与维护数据库</h2>
                            <h3>1. 创建数据库</h3>
                            <h4>基本语法</h4>
                            <pre><code class="language-sql">CREATE DATABASE &lt;数据库名&gt;;</code></pre>
                            <h4>指定字符集</h4>
                            <pre><code class="language-sql">CREATE DATABASE &lt;数据库名&gt; CHARACTER SET &lt;字符集名&gt;;</code></pre>
                            <h4>完整语法</h4>
                            <pre><code class="language-sql">CREATE DATABASE &lt;数据库名&gt; 
[DEFAULT] CHARACTER SET &lt;字符集名&gt; 
[COLLATE &lt;排序规则名&gt;];</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 创建基本数据库
CREATE DATABASE navicat_db;

-- 创建指定字符集的数据库
CREATE DATABASE sql_db CHARACTER SET gb2312;

-- 创建UTF8MB4字符集的数据库
CREATE DATABASE myapp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</code></pre>
                            <h3>2. 查看数据库</h3>
                            <h4>查看所有数据库</h4>
                            <pre><code class="language-sql">SHOW DATABASES;</code></pre>
                            <h4>查看数据库创建信息</h4>
                            <pre><code class="language-sql">SHOW CREATE DATABASE &lt;数据库名&gt;;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">SHOW CREATE DATABASE sql_db;</code></pre>
                            <h3>3. 修改数据库</h3>
                            <h4>修改字符集</h4>
                            <pre><code class="language-sql">ALTER DATABASE &lt;数据库名&gt; CHARACTER SET &lt;字符集名&gt;;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">ALTER DATABASE sql_db CHARACTER SET utf8mb4;</code></pre>
                            <h3>4. 使用数据库</h3>
                            <pre><code class="language-sql">USE &lt;数据库名&gt;;</code></pre>
                            <h3>5. 删除数据库</h3>
                            <pre><code class="language-sql">DROP DATABASE &lt;数据库名&gt;;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">DROP DATABASE navicat_db;
DROP DATABASE sql_db;</code></pre>
                            <hr>
                            <h2>创建与维护数据表</h2>
                            <h3>1. 创建数据表</h3>
                            <h4>基本语法</h4>
                            <pre><code class="language-sql">CREATE TABLE &lt;表名&gt; (
    字段名 数据类型 [约束条件],
    字段名 数据类型 [约束条件],
    ...
);</code></pre>
                            <h4>完整语法示例</h4>
                            <pre><code class="language-sql">CREATE TABLE course (
    cno CHAR(5) NOT NULL PRIMARY KEY,
    cname VARCHAR(20) NOT NULL,
    credit INT DEFAULT 0,
    description TEXT
);</code></pre>
                            <h4>常用数据类型</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>类型</th>
                                        <th>说明</th>
                                        <th>示例</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>INT</td>
                                        <td>整数</td>
                                        <td>age INT</td>
                                    </tr>
                                    <tr>
                                        <td>VARCHAR</td>
                                        <td>变长字符串</td>
                                        <td>name VARCHAR(50)</td>
                                    </tr>
                                    <tr>
                                        <td>CHAR</td>
                                        <td>定长字符串</td>
                                        <td>code CHAR(10)</td>
                                    </tr>
                                    <tr>
                                        <td>TEXT</td>
                                        <td>长文本</td>
                                        <td>content TEXT</td>
                                    </tr>
                                    <tr>
                                        <td>DATE</td>
                                        <td>日期</td>
                                        <td>birth DATE</td>
                                    </tr>
                                    <tr>
                                        <td>DATETIME</td>
                                        <td>日期时间</td>
                                        <td>created_at DATETIME</td>
                                    </tr>
                                    <tr>
                                        <td>DECIMAL</td>
                                        <td>精确小数</td>
                                        <td>price DECIMAL(10,2)</td>
                                    </tr>
                                    <tr>
                                        <td>BOOLEAN</td>
                                        <td>布尔值</td>
                                        <td>is_active BOOLEAN</td>
                                    </tr>
                                </tbody>
                            </table>
                            <h4>约束类型</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>约束</th>
                                        <th>说明</th>
                                        <th>示例</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>PRIMARY KEY</td>
                                        <td>主键</td>
                                        <td>id INT PRIMARY KEY</td>
                                    </tr>
                                    <tr>
                                        <td>FOREIGN KEY</td>
                                        <td>外键</td>
                                        <td>user_id INT REFERENCES users(id)</td>
                                    </tr>
                                    <tr>
                                        <td>NOT NULL</td>
                                        <td>非空</td>
                                        <td>name VARCHAR(50) NOT NULL</td>
                                    </tr>
                                    <tr>
                                        <td>UNIQUE</td>
                                        <td>唯一</td>
                                        <td>email VARCHAR(100) UNIQUE</td>
                                    </tr>
                                    <tr>
                                        <td>DEFAULT</td>
                                        <td>默认值</td>
                                        <td>status INT DEFAULT 0</td>
                                    </tr>
                                    <tr>
                                        <td>CHECK</td>
                                        <td>检查约束</td>
                                        <td>age INT CHECK(age &gt;= 18)</td>
                                    </tr>
                                </tbody>
                            </table>
                            <h4>复杂表示例</h4>
                            <pre><code class="language-sql">CREATE TABLE student (
    sno CHAR(10) NOT NULL PRIMARY KEY,
    sname VARCHAR(20) NOT NULL,
    ssex CHAR(2) DEFAULT '男',
    sage INT CHECK(sage BETWEEN 15 AND 50),
    sdept VARCHAR(30),
    speciality VARCHAR(50),
    enrollment_date DATE,
    FOREIGN KEY (sdept) REFERENCES department(dept_name)
);

CREATE TABLE score (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sno CHAR(10) NOT NULL,
    cno CHAR(5) NOT NULL,
    score DECIMAL(5,2) CHECK(score BETWEEN 0 AND 100),
    exam_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (sno) REFERENCES student(sno),
    FOREIGN KEY (cno) REFERENCES course(cno),
    UNIQUE KEY unique_student_course (sno, cno)
);</code></pre>
                            <h3>2. 插入数据</h3>
                            <h4>基本语法</h4>
                            <pre><code class="language-sql">INSERT INTO &lt;表名&gt; (字段1, 字段2, ...) VALUES (值1, 值2, ...);</code></pre>
                            <h4>批量插入</h4>
                            <pre><code class="language-sql">INSERT INTO course (cno, cname) VALUES
('C01', '数据库'),
('C02', '数学'),
('C03', '信息系统'),
('C04', '操作系统'),
('C05', '计算机网络');</code></pre>
                            <h4>插入完整记录</h4>
                            <pre><code class="language-sql">INSERT INTO student VALUES 
('2021001', '张三', '男', 20, '计算机', '软件工程', '2021-09-01'),
('2021002', '李四', '女', 19, '数学', '应用数学', '2021-09-01');</code></pre>
                            <h3>3. 修改表结构</h3>
                            <h4>添加字段</h4>
                            <pre><code class="language-sql">ALTER TABLE &lt;表名&gt; ADD &lt;字段名&gt; &lt;数据类型&gt; [约束];</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 添加入学时间字段
ALTER TABLE student ADD enrollment_date DATE;

-- 添加带默认值的字段
ALTER TABLE student ADD status INT DEFAULT 1;</code></pre>
                            <h4>修改字段类型</h4>
                            <pre><code class="language-sql">ALTER TABLE &lt;表名&gt; MODIFY &lt;字段名&gt; &lt;新数据类型&gt; [约束];</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 修改字段长度
ALTER TABLE student MODIFY sdept VARCHAR(50);

-- 修改字段类型和约束
ALTER TABLE student MODIFY sage INT NOT NULL;</code></pre>
                            <h4>修改字段名</h4>
                            <pre><code class="language-sql">ALTER TABLE &lt;表名&gt; CHANGE &lt;旧字段名&gt; &lt;新字段名&gt; &lt;数据类型&gt; [约束];</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 重命名字段
ALTER TABLE student CHANGE sdept sdepartment VARCHAR(30);

-- 同时修改字段名和类型
ALTER TABLE student CHANGE sdepartment dept_name VARCHAR(50) NOT NULL;</code></pre>
                            <h4>删除字段</h4>
                            <pre><code class="language-sql">ALTER TABLE &lt;表名&gt; DROP &lt;字段名&gt;;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 删除专业字段
ALTER TABLE student DROP speciality;</code></pre>
                            <h4>重命名表</h4>
                            <pre><code class="language-sql">ALTER TABLE &lt;旧表名&gt; RENAME &lt;新表名&gt;;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 重命名表
ALTER TABLE teaching RENAME teach;

-- 或者使用RENAME TABLE语句
RENAME TABLE old_table TO new_table;</code></pre>
                            <h3>4. 删除表</h3>
                            <pre><code class="language-sql">DROP TABLE &lt;表名&gt;;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">DROP TABLE teach;</code></pre>
                            <h3>5. 复制表</h3>
                            <h4>复制表结构和数据</h4>
                            <pre><code class="language-sql">CREATE TABLE &lt;新表名&gt; AS SELECT * FROM &lt;源表名&gt;;</code></pre>
                            <h4>只复制表结构</h4>
                            <pre><code class="language-sql">CREATE TABLE &lt;新表名&gt; LIKE &lt;源表名&gt;;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 完全复制
CREATE TABLE student_backup AS SELECT * FROM student;

-- 只复制结构
CREATE TABLE student_structure LIKE student;</code></pre>
                            <hr>
                            <h2>常用操作命令总结</h2>
                            <h3>数据库操作</h3>
                            <pre><code class="language-sql">-- 创建数据库
CREATE DATABASE db_name CHARACTER SET utf8mb4;

-- 查看所有数据库
SHOW DATABASES;

-- 使用数据库
USE db_name;

-- 查看当前数据库
SELECT DATABASE();

-- 修改数据库字符集
ALTER DATABASE db_name CHARACTER SET utf8mb4;

-- 删除数据库
DROP DATABASE db_name;</code></pre>
                            <h3>表操作</h3>
                            <pre><code class="language-sql">-- 创建表
CREATE TABLE table_name (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 查看所有表
SHOW TABLES;

-- 查看表结构
DESC table_name;
-- 或者
DESCRIBE table_name;

-- 查看创建表的SQL
SHOW CREATE TABLE table_name;

-- 重命名表
RENAME TABLE old_name TO new_name;

-- 删除表
DROP TABLE table_name;</code></pre>
                            <h3>字段操作</h3>
                            <pre><code class="language-sql">-- 添加字段
ALTER TABLE table_name ADD column_name VARCHAR(100);

-- 修改字段类型
ALTER TABLE table_name MODIFY column_name INT;

-- 修改字段名
ALTER TABLE table_name CHANGE old_name new_name VARCHAR(100);

-- 删除字段
ALTER TABLE table_name DROP column_name;

-- 添加主键
ALTER TABLE table_name ADD PRIMARY KEY (id);

-- 添加外键
ALTER TABLE table_name ADD FOREIGN KEY (user_id) REFERENCES users(id);</code></pre>
                            <h3>数据操作</h3>
                            <pre><code class="language-sql">-- 插入数据
INSERT INTO table_name (col1, col2) VALUES (value1, value2);

-- 查询数据
SELECT * FROM table_name WHERE condition;

-- 更新数据
UPDATE table_name SET col1 = value1 WHERE condition;

-- 删除数据
DELETE FROM table_name WHERE condition;</code></pre>
                            <hr>
                            <h2>实用技巧</h2>
                            <h3>1. 字符集设置</h3>
                            <pre><code class="language-sql">-- 创建数据库时指定字符集
CREATE DATABASE mydb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建表时指定字符集
CREATE TABLE mytable (
    id INT PRIMARY KEY
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</code></pre>
                            <h3>2. 索引操作</h3>
                            <pre><code class="language-sql">-- 添加普通索引
ALTER TABLE table_name ADD INDEX index_name (column_name);

-- 添加唯一索引
ALTER TABLE table_name ADD UNIQUE INDEX index_name (column_name);

-- 添加全文索引
ALTER TABLE table_name ADD FULLTEXT INDEX index_name (column_name);</code></pre>
                            <h3>3. 查看表信息</h3>
                            <pre><code class="language-sql">-- 查看表状态
SHOW TABLE STATUS LIKE 'table_name';

-- 查看表的索引
SHOW INDEX FROM table_name;

-- 查看表的列信息
SHOW COLUMNS FROM table_name;</code></pre>
                            <h3>4. 备份与恢复</h3>
                            <pre><code class="language-bash"># 备份数据库
mysqldump -u username -p database_name &gt; backup.sql

# 恢复数据库
mysql -u username -p database_name &lt; backup.sql</code></pre>
                            <h2>视图 (VIEW)</h2>
                            <h3>1. 什么是视图</h3>
                            <p>视图是基于SQL语句的结果集的可视化表。视图包含行和列，就像一个真实的表。视图中的字段就是来自一个或多个数据库表中的字段。</p>
                            <h3>2. 创建视图</h3>
                            <h4>基本语法</h4>
                            <pre><code class="language-sql">CREATE VIEW &lt;视图名&gt; AS
SELECT &lt;列名&gt; FROM &lt;表名&gt; [WHERE 条件];</code></pre>
                            <h4>创建复杂视图</h4>
                            <pre><code class="language-sql">CREATE VIEW student_course_view AS
SELECT 
    s.sno,
    s.sname,
    s.sdept,
    c.cno,
    c.cname,
    sc.score
FROM student s
JOIN score sc ON s.sno = sc.sno
JOIN course c ON sc.cno = c.cno;</code></pre>
                            <h4>创建带统计的视图</h4>
                            <pre><code class="language-sql">CREATE VIEW student_score_stats AS
SELECT 
    s.sno,
    s.sname,
    COUNT(sc.cno) AS course_count,
    AVG(sc.score) AS avg_score,
    MAX(sc.score) AS max_score,
    MIN(sc.score) AS min_score
FROM student s
LEFT JOIN score sc ON s.sno = sc.sno
GROUP BY s.sno, s.sname;</code></pre>
                            <h3>3. 查看视图</h3>
                            <h4>查看所有视图</h4>
                            <pre><code class="language-sql">SHOW FULL TABLES WHERE table_type = 'VIEW';</code></pre>
                            <h4>查看视图结构</h4>
                            <pre><code class="language-sql">DESC &lt;视图名&gt;;
-- 或者
DESCRIBE &lt;视图名&gt;;</code></pre>
                            <h4>查看视图创建语句</h4>
                            <pre><code class="language-sql">SHOW CREATE VIEW &lt;视图名&gt;;</code></pre>
                            <h3>4. 使用视图</h3>
                            <h4>查询视图数据</h4>
                            <pre><code class="language-sql">-- 基本查询
SELECT * FROM student_course_view;

-- 带条件查询
SELECT * FROM student_course_view WHERE sdept = '计算机';

-- 统计查询
SELECT sdept, AVG(score) as avg_score 
FROM student_course_view 
GROUP BY sdept;</code></pre>
                            <h3>5. 修改视图</h3>
                            <h4>替换视图</h4>
                            <pre><code class="language-sql">CREATE OR REPLACE VIEW &lt;视图名&gt; AS
SELECT &lt;新查询语句&gt;;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">CREATE OR REPLACE VIEW student_course_view AS
SELECT 
    s.sno,
    s.sname,
    s.ssex,
    s.sdept,
    c.cno,
    c.cname,
    c.credit,
    sc.score,
    CASE 
        WHEN sc.score &gt;= 90 THEN '优秀'
        WHEN sc.score &gt;= 80 THEN '良好'
        WHEN sc.score &gt;= 60 THEN '及格'
        ELSE '不及格'
    END AS grade_level
FROM student s
JOIN score sc ON s.sno = sc.sno
JOIN course c ON sc.cno = c.cno;</code></pre>
                            <h3>6. 删除视图</h3>
                            <pre><code class="language-sql">DROP VIEW &lt;视图名&gt;;</code></pre>
                            <h3>7. 视图的优点</h3>
                            <ul>
                                <li><strong>简化查询</strong>：将复杂的SQL查询封装为简单的视图</li>
                                <li><strong>安全性</strong>：只显示用户需要的数据，隐藏敏感信息</li>
                                <li><strong>逻辑独立性</strong>：表结构改变时，只需修改视图</li>
                                <li><strong>数据一致性</strong>：确保数据的一致性显示SQL 编程</li>
                            </ul>
                            <h3>1. 变量声明与使用</h3>
                            <h4>用户变量</h4>
                            <pre><code class="language-sql">-- 声明变量
SET @variable_name = value;

-- 使用变量
SELECT @variable_name;

-- 示例
SET @student_id = '2021001';
SELECT * FROM student WHERE sno = @student_id;</code></pre>
                            <h4>局部变量（在存储过程中使用）</h4>
                            <pre><code class="language-sql">DECLARE variable_name data_type [DEFAULT value];</code></pre>
                            <h3>2. 条件语句</h3>
                            <h4>IF-ELSE 语句</h4>
                            <pre><code class="language-sql">IF condition THEN
    -- 语句块
ELSEIF condition THEN
    -- 语句块
ELSE
    -- 语句块
END IF;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">SET @score = 85;
SET @grade = '';

IF @score &gt;= 90 THEN
    SET @grade = 'A';
ELSEIF @score &gt;= 80 THEN
    SET @grade = 'B';
ELSEIF @score &gt;= 60 THEN
    SET @grade = 'C';
ELSE
    SET @grade = 'D';
END IF;

SELECT @grade AS grade;</code></pre>
                            <h4>CASE 语句</h4>
                            <pre><code class="language-sql">CASE 
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ELSE result_n
END</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">SELECT 
    sname,
    score,
    CASE 
        WHEN score &gt;= 90 THEN '优秀'
        WHEN score &gt;= 80 THEN '良好'
        WHEN score &gt;= 60 THEN '及格'
        ELSE '不及格'
    END AS grade
FROM student_course_view;</code></pre>
                            <h3>3. 循环语句</h3>
                            <h4>WHILE 循环</h4>
                            <pre><code class="language-sql">WHILE condition DO
    -- 循环体
END WHILE;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 计算1到10的和
SET @total = 0;
SET @i = 1;

WHILE @i &lt;= 10 DO
    SET @total = @total + @i;
    SET @i = @i + 1;
END WHILE;

SELECT @total AS sum_result;</code></pre>
                            <h4>REPEAT 循环</h4>
                            <pre><code class="language-sql">REPEAT
    -- 循环体
UNTIL condition
END REPEAT;</code></pre>
                            <h4>LOOP 循环</h4>
                            <pre><code class="language-sql">loop_label: LOOP
    -- 循环体
    IF condition THEN
        LEAVE loop_label;
    END IF;
END LOOP loop_label;</code></pre>
                            <h3>4. 存储过程</h3>
                            <h4>创建存储过程</h4>
                            <pre><code class="language-sql">DELIMITER //
CREATE PROCEDURE procedure_name ([参数列表])
BEGIN
    -- 存储过程体
END //
DELIMITER ;</code></pre>
                            <h4>参数类型</h4>
                            <pre><code class="language-sql">-- IN 参数（输入参数）
CREATE PROCEDURE get_student(IN student_id CHAR(10))
BEGIN
    SELECT * FROM student WHERE sno = student_id;
END;

-- OUT 参数（输出参数）
CREATE PROCEDURE get_student_count(IN dept_name VARCHAR(30), OUT student_count INT)
BEGIN
    SELECT COUNT(*) INTO student_count 
    FROM student WHERE sdept = dept_name;
END;

-- INOUT 参数（输入输出参数）
CREATE PROCEDURE update_counter(INOUT counter INT, increment_val INT)
BEGIN
    SET counter = counter + increment_val;
END;</code></pre>
                            <h4>调用存储过程</h4>
                            <pre><code class="language-sql">-- 调用带IN参数的存储过程
CALL get_student('2021001');

-- 调用带OUT参数的存储过程
CALL get_student_count('计算机', @count);
SELECT @count;

-- 调用带INOUT参数的存储过程
SET @counter = 10;
CALL update_counter(@counter, 5);
SELECT @counter;</code></pre>
                            <h4>实际示例</h4>
                            <pre><code class="language-sql">DELIMITER //
CREATE PROCEDURE update_student_score(
    IN student_no CHAR(10),
    IN course_no CHAR(5),
    IN new_score DECIMAL(5,2),
    OUT result_message VARCHAR(100)
)
BEGIN
    DECLARE existing_score DECIMAL(5,2) DEFAULT NULL;
    
    -- 检查成绩是否存在
    SELECT score INTO existing_score 
    FROM score 
    WHERE sno = student_no AND cno = course_no;
    
    IF existing_score IS NOT NULL THEN
        -- 更新成绩
        UPDATE score SET score = new_score 
        WHERE sno = student_no AND cno = course_no;
        SET result_message = '成绩更新成功';
    ELSE
        -- 插入新成绩
        INSERT INTO score (sno, cno, score) 
        VALUES (student_no, course_no, new_score);
        SET result_message = '成绩插入成功';
    END IF;
END //
DELIMITER ;</code></pre>
                            <h3>5. 函数</h3>
                            <h4>创建函数</h4>
                            <pre><code class="language-sql">DELIMITER //
CREATE FUNCTION function_name ([参数列表]) RETURNS return_type
BEGIN
    -- 函数体
    RETURN return_value;
END //
DELIMITER ;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">DELIMITER //
CREATE FUNCTION calculate_grade(score DECIMAL(5,2)) RETURNS VARCHAR(10)
DETERMINISTIC
BEGIN
    DECLARE grade VARCHAR(10);
    
    IF score &gt;= 90 THEN
        SET grade = 'A';
    ELSEIF score &gt;= 80 THEN
        SET grade = 'B';
    ELSEIF score &gt;= 60 THEN
        SET grade = 'C';
    ELSE
        SET grade = 'D';
    END IF;
    
    RETURN grade;
END //
DELIMITER ;</code></pre>
                            <h4>使用函数</h4>
                            <pre><code class="language-sql">SELECT 
    sno,
    cno,
    score,
    calculate_grade(score) AS grade
FROM score;</code></pre>
                            <h4>更多函数示例</h4>
                            <pre><code class="language-sql">-- 计算GPA的函数
DELIMITER //
CREATE FUNCTION calculate_gpa(student_id CHAR(10)) RETURNS DECIMAL(3,2)
DETERMINISTIC
BEGIN
    DECLARE gpa DECIMAL(3,2) DEFAULT 0.00;
    
    SELECT AVG(score)/20 INTO gpa
    FROM score 
    WHERE sno = student_id;
    
    RETURN gpa;
END //
DELIMITER ;

-- 字符串处理函数
DELIMITER //
CREATE FUNCTION format_student_name(full_name VARCHAR(50)) RETURNS VARCHAR(50)
DETERMINISTIC
BEGIN
    DECLARE formatted_name VARCHAR(50);
    
    -- 将姓名格式化为：姓 名（首字母大写）
    SET formatted_name = CONCAT(
        UPPER(LEFT(full_name, 1)), 
        LOWER(SUBSTRING(full_name, 2))
    );
    
    RETURN formatted_name;
END //
DELIMITER ;</code></pre>
                            <h3>6. 触发器</h3>
                            <h4>创建触发器</h4>
                            <pre><code class="language-sql">DELIMITER //
CREATE TRIGGER trigger_name
{BEFORE | AFTER} {INSERT | UPDATE | DELETE}
ON table_name
FOR EACH ROW
BEGIN
    -- 触发器逻辑
END //
DELIMITER ;</code></pre>
                            <h4>示例</h4>
                            <pre><code class="language-sql">-- 插入前触发器：自动设置创建时间
DELIMITER //
CREATE TRIGGER before_student_insert
BEFORE INSERT ON student
FOR EACH ROW
BEGIN
    IF NEW.enrollment_date IS NULL THEN
        SET NEW.enrollment_date = CURRENT_DATE();
    END IF;
END //
DELIMITER ;

-- 更新后触发器：记录修改日志
DELIMITER //
CREATE TRIGGER after_student_update
AFTER UPDATE ON student
FOR EACH ROW
BEGIN
    INSERT INTO student_log (
        student_id, 
        old_name, 
        new_name, 
        operation, 
        log_time
    ) VALUES (
        NEW.sno,
        OLD.sname,
        NEW.sname,
        'UPDATE',
        NOW()
    );
END //
DELIMITER ;

-- 删除前触发器：检查约束
DELIMITER //
CREATE TRIGGER before_student_delete
BEFORE DELETE ON student
FOR EACH ROW
BEGIN
    DECLARE score_count INT;
    
    -- 检查学生是否有成绩记录
    SELECT COUNT(*) INTO score_count
    FROM score WHERE sno = OLD.sno;
    
    IF score_count &gt; 0 THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = '无法删除有成绩记录的学生';
    END IF;
END //
DELIMITER ;</code></pre>
                            <h3>7. 游标</h3>
                            <h4>游标基本使用</h4>
                            <pre><code class="language-sql">DELIMITER //
CREATE PROCEDURE cursor_example()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE student_id CHAR(10);
    DECLARE student_name VARCHAR(20);
    DECLARE avg_score DECIMAL(5,2);
    
    -- 声明游标
    DECLARE student_cursor CURSOR FOR 
        SELECT sno, sname FROM student;
    
    -- 声明异常处理
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- 创建临时表存储结果
    CREATE TEMPORARY TABLE IF NOT EXISTS temp_results (
        student_id CHAR(10),
        student_name VARCHAR(20),
        avg_score DECIMAL(5,2)
    );
    
    -- 打开游标
    OPEN student_cursor;
    
    read_loop: LOOP
        -- 读取游标数据
        FETCH student_cursor INTO student_id, student_name;
        
        -- 退出条件
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- 计算平均成绩
        SELECT AVG(score) INTO avg_score 
        FROM score 
        WHERE sno = student_id;
        
        -- 插入结果
        INSERT INTO temp_results VALUES 
        (student_id, student_name, IFNULL(avg_score, 0));
        
    END LOOP;
    
    -- 关闭游标
    CLOSE student_cursor;
    
    -- 返回结果
    SELECT * FROM temp_results;
    
    -- 清理临时表
    DROP TEMPORARY TABLE IF EXISTS temp_results;
    
END //
DELIMITER ;</code></pre>
                            <h3>8. 事务处理</h3>
                            <h4>事务基本语法</h4>
                            <pre><code class="language-sql">-- 开始事务
START TRANSACTION;

-- 执行SQL语句
UPDATE account SET balance = balance - 100 WHERE user_id = 1;
UPDATE account SET balance = balance + 100 WHERE user_id = 2;

-- 提交事务或回滚
COMMIT;  -- 提交
-- 或者
ROLLBACK; -- 回滚</code></pre>
                            <h4>事务示例</h4>
                            <pre><code class="language-sql">DELIMITER //
CREATE PROCEDURE transfer_money(
    IN from_account INT,
    IN to_account INT,
    IN amount DECIMAL(10,2),
    OUT result_message VARCHAR(100)
)
BEGIN
    DECLARE from_balance DECIMAL(10,2);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET result_message = '转账失败，已回滚';
    END;
    
    -- 开始事务
    START TRANSACTION;
    
    -- 检查余额
    SELECT balance INTO from_balance 
    FROM account 
    WHERE account_id = from_account;
    
    IF from_balance &lt; amount THEN
        SET result_message = '余额不足';
        ROLLBACK;
    ELSE
        -- 扣款
        UPDATE account 
        SET balance = balance - amount 
        WHERE account_id = from_account;
        
        -- 入账
        UPDATE account 
        SET balance = balance + amount 
        WHERE account_id = to_account;
        
        -- 记录交易日志
        INSERT INTO transaction_log (
            from_account, 
            to_account, 
            amount, 
            transaction_time
        ) VALUES (
            from_account, 
            to_account, 
            amount, 
            NOW()
        );
        
        COMMIT;
        SET result_message = '转账成功';
    END IF;
END //
DELIMITER ;</code></pre>
                            <h3>9. 错误处理</h3>
                            <h4>DECLARE HANDLER 语法</h4>
                            <pre><code class="language-sql">DECLARE handler_type HANDLER 
FOR condition_value [, condition_value] ...
statement

-- handler_type:
--   CONTINUE: 继续执行
--   EXIT: 退出执行
--   UNDO: 回滚（事务中使用）

-- condition_value:
--   SQLSTATE 'VALUE'
--   SQLWARNING
--   NOT FOUND
--   SQLEXCEPTION</code></pre>
                            <h4>错误处理示例</h4>
                            <pre><code class="language-sql">DELIMITER //
CREATE PROCEDURE safe_divide(
    IN dividend DECIMAL(10,2),
    IN divisor DECIMAL(10,2),
    OUT result DECIMAL(10,2),
    OUT error_message VARCHAR(100)
)
BEGIN
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        GET DIAGNOSTICS CONDITION 1
        error_message = MESSAGE_TEXT;
    END;
    
    IF divisor = 0 THEN
        SET error_message = '除数不能为零';
        SET result = NULL;
    ELSE
        SET result = dividend / divisor;
        SET error_message = '计算成功';
    END IF;
END //
DELIMITER ;</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</body>

</html>